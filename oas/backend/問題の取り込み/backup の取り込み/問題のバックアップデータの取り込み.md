元々はこのシステムの主キー(id)は uuid でしたが、事情により 主キー(id) auto increments に変更し、
元の主キー(uuid)は、uuid を移行しています。

今回取り込む CSV は以降前なので主キーが(uuid)になっています。

{参考 QuestionJson の取り込みコマンド} を参考にして、
{条件] に従い、{questions のパス｝　と {question_translations のパス} の CSV から questions と question_translations のデータを取得して　questions にインサートするコマンドを作成してください





# 条件
{questions のパス} の generated_by_llm true のもののみを対象とする
question_translations は、question_id が {questions のパス} の id と対応している。（現在は、id は auto increments で uuid は uuid カラムに移動済）

level_id は、リレーション先の levels の id を入れたいので、level_id と対応する、levels の CSV　の id　を探索して 該当した levels の json_id を元に levels テーブルを where('json_id') して levels の ID を取得してください
grade_id は、リレーション先の grades の id を入れたいので、grade_id と対応する、grades の CSV　の id　を探索して 該当した grades の json_id を元に grades テーブルを where('json_id') して grades の ID を取得してください
difficulty_id は、リレーション先の difficulties の id を入れたいので、difficulty_id と対応する、difficulties の CSV　の id　を探索して 該当した difficulties の json_id を元に difficulties テーブルを where('json_id') して difficulties の ID を取得してください

エラーが発生した時はロールバックしてください

namespace は、namespace App\Console\Commands\Import\Backup;

それ以外のカラムはCSVと同様の名前のカラムに全てインサートして。

CSVには、JSONデータが含まれているので注意しないとJSON内のカンマなどが反応してエラーの原因になります

値が空文字だとエラーになるので、必ず全てに空文字チェックを入れて空文字なら　null を入れてください。

questions は question_skill で、skills テーブルと紐づいています。skill_id は 4 で固定でよいので、questions の生成時に紐づけしてください。

questions のパス
backup/questions.csv

question_translations のパス
backup/question_translations.csv

levels のパス
backup/levels.csv

grades のパス
backup/grades.csv

difficulties のパス
backup/difficulties.csv

↓{questions のパス｝にあるCSVデータの中身
id,level_id,grade_id,difficulty_id,json_id,metadata,version,status,evaluation_method,checker_method,llm_evaluation_prompt_file_name,evaluation_response_format,question_type,learning_requirement_json,learning_subject,learning_no,learning_requirement,learning_required_competency,learning_background,learning_category,learning_grade_level,learning_url,order,generated_by_llm,created_at,updated_at,deleted_at
7f7c14bb-6598-4ba2-bbbc-00bb42618cb6,857730f9-6862-4713-b139-d2d77fd0e64d,144e93ba-2af4-4fa8-8148-85467b5e1521,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g3_sec100_u300_diff100_qt51_v100_1300,"{""question_type"":""FILL_IN_THE_BLANK"",""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""4桁 + 3桁のたし算を、各くらいに分けて計算する問題です。くり上がりがあれば注意して整理しながら、筆算の手順を確認してみましょう。"",""en"":""This is an addition exercise of a four-digit number plus a three-digit number, broken down by place values. Watch out for any carries and carefully verify the column addition steps.""},""background"":{""ja"":""4桁 + 3桁の加法でも、位を意識した筆算を使いこなせるようになるための問題です。各位を分解して足し合わせることで、繰り上がりを見逃さずに正確な合計を求める練習になります。"",""en"":""The purpose of this problem is to ensure that learners can handle four-digit plus three-digit addition correctly, using place-value column addition. By breaking down each place, you can practice handling carries accurately.""},""question"":{""ja"":""3241 + 567 = (3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = ▢ + ▢ + ▢ + ▢ = ▢"",""en"":""3241 + 567 = (3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = ▢ + ▢ + ▢ + ▢ = ▢""},""input_format"":{""fields"":[{""field_id"":""f_1"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_2"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_3"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_4"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_5"",""attribute"":""number"",""user_answer"":""number""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""3241 + 567 = "",""en"":""3241 + 567 = ""},""order"":50},{""type"":""newline"",""order"":100},{""type"":""text"",""content"":{""ja"":""(3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = "",""en"":""(3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = ""},""order"":150},{""type"":""newline"",""order"":200},{""type"":""input_field"",""field_id"":""f_1"",""order"":250},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":300},{""type"":""input_field"",""field_id"":""f_2"",""order"":350},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":400},{""type"":""input_field"",""field_id"":""f_3"",""order"":450},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":500},{""type"":""input_field"",""field_id"":""f_4"",""order"":550},{""type"":""text"",""content"":{""ja"":"" = "",""en"":"" = ""},""order"":600},{""type"":""input_field"",""field_id"":""f_5"",""order"":650}]}}",1.0.0,300,1,50,,"{""is_correct"":""boolean"",""score"":""number"",""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""4桁の数と3桁の数のたし算です。千、百、十、一のくらいに分けて足すことで、くり上がりを整理しやすくなっています。"",""en"":""This is an addition problem involving a four-digit and a three-digit number. By splitting them into thousands, hundreds, tens, and ones places, it becomes easier to handle carrying.""},""question"":{""ja"":""3241 + 567 = (3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = ▢ + ▢ + ▢ + ▢ = ▢"",""en"":""3241 + 567 = (3000 + 0) + (200 + 500) + (40 + 60) + (1 + 7) = ▢ + ▢ + ▢ + ▢ = ▢""},""fields"":[{""field_id"":""f_1"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":3000,""en"":3000},""field_explanation"":{""ja"":""千のくらいどうしを足すと3000です（3241の3000と567の0）。"",""en"":""Adding the thousands place gives 3000 (3000 from 3241 plus 0 from 567).""}},{""field_id"":""f_2"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":700,""en"":700},""field_explanation"":{""ja"":""百のくらいどうしを足すと700です（200+500）。"",""en"":""Adding the hundreds place results in 700 (200 + 500).""}},{""field_id"":""f_3"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":100,""en"":100},""field_explanation"":{""ja"":""十のくらいどうしを足すと100です（40+60）。"",""en"":""Adding the tens place yields 100 (40 + 60).""}},{""field_id"":""f_4"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":8,""en"":8},""field_explanation"":{""ja"":""一のくらいどうしを足すと8です（1+7）。"",""en"":""Adding the ones place gives 8 (1 + 7).""}},{""field_id"":""f_5"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":3808,""en"":3808},""field_explanation"":{""ja"":""3000 + 700 + 100 + 8 を合わせると3808となります。"",""en"":""Summing 3000 + 700 + 100 + 8 results in 3808.""}}]}",51,"[{""learning_subject"":""算数"",""learning_no"":37,""learning_requirement"":""計算の意味・方法 大きな数の概念と活用 3位数や4位数の加法及び減法"",""learning_required_competency"":""・3～4桁どうしの足し算・引き算を繰り上がり・繰り下がり含め正確に計算できる。"",""learning_background"":""・筆算の手順をしっかり確立させる。"",""learning_category"":""A"",""learning_grade_level"":""小3""}]",算数,37,計算の意味・方法 大きな数の概念と活用 3位数や4位数の加法及び減法,・3～4桁どうしの足し算・引き算を繰り上がり・繰り下がり含め正確に計算できる。,・筆算の手順をしっかり確立させる。,A,小3,,1300,0,2025-03-17 10:18:09,2025-03-26 02:46:49,
348a1d5d-c06c-48ea-b9ad-01150244ab4a,857730f9-6862-4713-b139-d2d77fd0e64d,144e93ba-2af4-4fa8-8148-85467b5e1521,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g3_sec100_u400_diff100_qt51_v100_610,"{""question_type"":""FILL_IN_THE_BLANK"",""question"":{""ja"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = ▢ + ▢ + ▢ + ▢ = ▢"",""en"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = ▢ + ▢ + ▢ + ▢ = ▢""},""question_text"":{""ja"":""次の▢にあてはまる数を答えなさい。"",""en"":""Please fill in the blanks with the correct numbers.""},""explanation"":{""ja"":""位ごとに分けて部分積を求めることで、2桁同士の乗法を解きましょう。"",""en"":""By splitting the numbers into tens and ones, you can practice solving two-digit multiplication through partial products.""},""background"":{""ja"":""この問題では、より大きな数の乗法を理解するために、部分積の考え方を学びます。"",""en"":""This problem helps you understand multiplication of larger numbers by learning partial product strategies.""},""input_format"":{""type"":""fixed"",""fields"":[{""field_id"":""f_1"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_2"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_3"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_4"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_5"",""attribute"":""number"",""user_answer"":""number""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = "",""en"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = ""},""order"":50,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_1"",""order"":100,""attribute"":""blank"",""content"":{""ja"":"""",""en"":""""}},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":150,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_2"",""order"":200,""attribute"":""blank"",""content"":{""ja"":"""",""en"":""""}},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":250,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_3"",""order"":300,""attribute"":""blank"",""content"":{""ja"":"""",""en"":""""}},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":350,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_4"",""order"":400,""attribute"":""blank"",""content"":{""ja"":"""",""en"":""""}},{""type"":""text"",""content"":{""ja"":"" = "",""en"":"" = ""},""order"":450,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_5"",""order"":500,""attribute"":""blank"",""content"":{""ja"":"""",""en"":""""}}]}}",1.0.0,300,1,50,,"{""is_correct"":""boolean"",""score"":""number"",""question_text"":{""ja"":""次の▢にあてはまる数を答えなさい。"",""en"":""Please fill in the blanks with the correct numbers.""},""explanation"":{""ja"":""2桁×2桁のかけ算を位に分解して、部分ごとの積を合計する練習です。80×40、80×7、4×40、4×7を順に計算し、すべてを足し合わせます。"",""en"":""In this practice problem, break down the two-digit multiplication into partial products and add them together. Calculate 80×40, 80×7, 4×40, and 4×7 in sequence and sum them all up.""},""question"":{""ja"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = ▢ + ▢ + ▢ + ▢ = ▢"",""en"":""84 × 47 = (80×40) + (80×7) + (4×40) + (4×7) = ▢ + ▢ + ▢ + ▢ = ▢""},""fields"":[{""field_id"":""f_1"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":3200,""en"":3200},""field_explanation"":{""ja"":""80 × 40 は 3200 となります。"",""en"":""80 × 40 equals 3200.""}},{""field_id"":""f_2"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":560,""en"":560},""field_explanation"":{""ja"":""80 × 7 は 560 となります。"",""en"":""80 × 7 equals 560.""}},{""field_id"":""f_3"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":160,""en"":160},""field_explanation"":{""ja"":""4 × 40 は 160 となります。"",""en"":""4 × 40 equals 160.""}},{""field_id"":""f_4"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":28,""en"":28},""field_explanation"":{""ja"":""4 × 7 は 28 となります。"",""en"":""4 × 7 equals 28.""}},{""field_id"":""f_5"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":3948,""en"":3948},""field_explanation"":{""ja"":""3200 + 560 + 160 + 28 を足し合わせると 3948 となります。"",""en"":""Adding 3200, 560, 160, and 28 results in 3948.""}}]}",51,"[{""learning_subject"":""算数"",""learning_no"":38,""learning_requirement"":""計算の意味・方法 大きな数の概念と活用 2位数や3位数の乗法"",""learning_required_competency"":""・2桁×2桁や3桁×1桁など，大きめのかけ算を正確に行える。"",""learning_background"":""・計算量が増えるため，桁のそろえ方や筆算手順を重点的に練習する。"",""learning_category"":""A"",""learning_grade_level"":""小3"",""learning_url"":""""}]",算数,38,計算の意味・方法 大きな数の概念と活用 2位数や3位数の乗法,・2桁×2桁や3桁×1桁など，大きめのかけ算を正確に行える。,・計算量が増えるため，桁のそろえ方や筆算手順を重点的に練習する。,A,小3,,1776,1,2025-03-23 05:45:39,2025-03-23 05:45:39,
e4446631-5ae5-44fc-ae09-01282858654f,857730f9-6862-4713-b139-d2d77fd0e64d,144e93ba-2af4-4fa8-8148-85467b5e1521,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g3_sec300_u100_diff100_qt251_v100_300,"{""question_type"":""CLASSIFY_THE_OPTIONS"",""question"":{""ja"":""28, 36, 39, 44, 54, 56, 62, 64, 81, 90"",""en"":""28, 36, 39, 44, 54, 56, 62, 64, 81, 90""},""question_text"":{""ja"":""つぎの2桁の整数を2, 3, 6, 8, 9で割り切れるように分けましょう"",""en"":""Classify these two-digit numbers according to which are divisible by 2, 3, 6, 8, and 9""},""explanation"":{""ja"":""この問題では、わり算の九九を活用し、あまりが出ない条件をもとに2桁の数を分類する力を養います。同じ数でも複数のグループに入る場合があるので注意して仕分けてみましょう。"",""en"":""In this task, you will use multiplication\/division facts to identify which numbers can be divided by 2, 3, 6, 8, or 9 without a remainder. Note that some numbers may belong to multiple categories.""},""background"":{""ja"":""1桁の除数による割り算を理解し、2桁の整数がどの数で割り切れるのかを把握する練習です。かけ算の知識を逆に使うことで素早く分類できるようになります。"",""en"":""This exercise helps learners practice single-digit divisors with two-digit numbers. By reversing multiplication facts, learners can quickly figure out which numbers fall into each divisibility category.""},""input_format"":{""input_components"":[{""type"":""number"",""content"":{""ja"":""28"",""en"":""28""},""order"":50},{""type"":""number"",""content"":{""ja"":""36"",""en"":""36""},""order"":100},{""type"":""number"",""content"":{""ja"":""39"",""en"":""39""},""order"":150},{""type"":""number"",""content"":{""ja"":""44"",""en"":""44""},""order"":200},{""type"":""number"",""content"":{""ja"":""54"",""en"":""54""},""order"":250},{""type"":""number"",""content"":{""ja"":""56"",""en"":""56""},""order"":300},{""type"":""number"",""content"":{""ja"":""62"",""en"":""62""},""order"":350},{""type"":""number"",""content"":{""ja"":""64"",""en"":""64""},""order"":400},{""type"":""number"",""content"":{""ja"":""81"",""en"":""81""},""order"":450},{""type"":""number"",""content"":{""ja"":""90"",""en"":""90""},""order"":500}],""fields"":[{""field_id"":""f_1"",""attribute"":""array"",""user_answer"":""sequence""},{""field_id"":""f_2"",""attribute"":""array"",""user_answer"":""sequence""},{""field_id"":""f_3"",""attribute"":""array"",""user_answer"":""sequence""},{""field_id"":""f_4"",""attribute"":""array"",""user_answer"":""sequence""},{""field_id"":""f_5"",""attribute"":""array"",""user_answer"":""sequence""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""2で割り切れる数"",""en"":""Numbers divisible by 2""},""order"":50,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_1"",""order"":100},{""type"":""newline"",""order"":150},{""type"":""text"",""content"":{""ja"":""3で割り切れる数"",""en"":""Numbers divisible by 3""},""order"":250,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_2"",""order"":300},{""type"":""newline"",""order"":350},{""type"":""text"",""content"":{""ja"":""6で割り切れる数"",""en"":""Numbers divisible by 6""},""order"":450,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_3"",""order"":500},{""type"":""newline"",""order"":550},{""type"":""text"",""content"":{""ja"":""8で割り切れる数"",""en"":""Numbers divisible by 8""},""order"":650,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_4"",""order"":700},{""type"":""newline"",""order"":750},{""type"":""text"",""content"":{""ja"":""9で割り切れる数"",""en"":""Numbers divisible by 9""},""order"":850,""attribute"":""text""},{""type"":""input_field"",""field_id"":""f_5"",""order"":900},{""type"":""newline"",""order"":950}]}}",1.0.0,300,1,100,,"{""is_correct"":""boolean"",""score"":""number"",""question_text"":{""ja"":""次の2桁の整数を、2, 3, 6, 8, 9で割り切れる数ごとに分けましょう。"",""en"":""Classify the following two-digit numbers based on which are divisible by 2, 3, 6, 8, or 9.""},""explanation"":{""ja"":""この問題では、与えられた2桁の整数(28, 36, 39, 44, 54, 56, 62, 64, 81, 90)が、それぞれ2, 3, 6, 8, 9のいずれで割り切れるかを判別し、あまりが出ない分類に整理します。割り算の九九を使って効率よく確認してみましょう。"",""en"":""In this problem, you have ten two-digit numbers (28, 36, 39, 44, 54, 56, 62, 64, 81, 90). Determine which are divisible by 2, 3, 6, 8, or 9 with no remainder. Use your multiplication\/division facts to check each one.""},""question"":{""ja"":""28, 36, 39, 44, 54, 56, 62, 64, 81, 90"",""en"":""28, 36, 39, 44, 54, 56, 62, 64, 81, 90""},""fields"":[{""field_id"":""f_1"",""user_answer"":""sequence"",""is_correct"":""boolean"",""collect_answer"":{""ja"":""[28, 36, 44, 54, 56, 62, 64, 90]"",""en"":""[28, 36, 44, 54, 56, 62, 64, 90]""},""field_explanation"":{""ja"":""2で割り切れる、つまり偶数である数は28, 36, 44, 54, 56, 62, 64, 90です。"",""en"":""All even numbers in the list are divisible by 2: 28, 36, 44, 54, 56, 62, 64, and 90.""}},{""field_id"":""f_2"",""user_answer"":""sequence"",""is_correct"":""boolean"",""collect_answer"":{""ja"":""[36, 39, 54, 81, 90]"",""en"":""[36, 39, 54, 81, 90]""},""field_explanation"":{""ja"":""3で割り切れる数は、3の段を使ってあまりが出ないか調べると36, 39, 54, 81, 90です。"",""en"":""These are multiples of 3 with no remainder: 36, 39, 54, 81, and 90.""}},{""field_id"":""f_3"",""user_answer"":""sequence"",""is_correct"":""boolean"",""collect_answer"":{""ja"":""[36, 54, 90]"",""en"":""[36, 54, 90]""},""field_explanation"":{""ja"":""6で割り切れる数は、2の倍数かつ3の倍数である必要があります。36, 54, 90はいずれも6×(整数)で表せます。"",""en"":""Numbers divisible by 6 must be multiples of both 2 and 3: 36, 54, and 90.""}},{""field_id"":""f_4"",""user_answer"":""sequence"",""is_correct"":""boolean"",""collect_answer"":{""ja"":""[56, 64]"",""en"":""[56, 64]""},""field_explanation"":{""ja"":""8の倍数かどうかは、8×7=56, 8×8=64などの段で確認できます。"",""en"":""These numbers (56 and 64) are multiples of 8: 56 = 8×7 and 64 = 8×8.""}},{""field_id"":""f_5"",""user_answer"":""sequence"",""is_correct"":""boolean"",""collect_answer"":{""ja"":""[36, 54, 81, 90]"",""en"":""[36, 54, 81, 90]""},""field_explanation"":{""ja"":""9で割り切れる数は、各桁の合計が9の倍数になります。36, 54, 81, 90はいずれも9で割り切れます。"",""en"":""Numbers divisible by 9 have digit sums that are multiples of 9: 36, 54, 81, and 90 are all divisible by 9.""}}]}",251,"[{""learning_subject"":""算数"",""learning_no"":40,""learning_requirement"":""計算の意味・方法 割り算 1位数などの除法"",""learning_required_competency"":""1桁わり算(27÷3等)を九九を用いてスムーズに解ける。"",""learning_background"":""2桁以上の除法に進む基礎固め。逆算としてかけ算との結び付きも確認。"",""learning_category"":""A"",""learning_grade_level"":""小3""}]",算数,40,計算の意味・方法 割り算 1位数などの除法,1桁わり算(27÷3等)を九九を用いてスムーズに解ける。,2桁以上の除法に進む基礎固め。逆算としてかけ算との結び付きも確認。,A,小3,,300,0,2025-03-26 02:47:03,2025-03-26 02:47:03,
a5019024-0370-4d0f-80bd-015c68d7e3f3,857730f9-6862-4713-b139-d2d77fd0e64d,144e93ba-2af4-4fa8-8148-85467b5e1521,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g3_sec100_u300_diff100_qt51_v100_213,"{""question_type"":""FILL_IN_THE_BLANK"",""question_text"":{""ja"":""▢にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""3桁同士の足し算で、繰り上がりが2回ある問題に取り組みましょう。"",""en"":""Let's practice adding two three-digit numbers with two carries.""},""background"":{""ja"":""この問題では、合計が4桁になる3桁の足し算を練習します。"",""en"":""In this problem, you will practice adding two three-digit numbers that result in a four-digit sum.""},""question"":{""ja"":""823 + 479 = (800 + 400) + (20 + 70) + (3 + 9) = ▢ + ▢ + ▢ = ▢"",""en"":""823 + 479 = (800 + 400) + (20 + 70) + (3 + 9) = ▢ + ▢ + ▢ = ▢""},""input_format"":{""type"":""fixed"",""fields"":[{""field_id"":""f_1"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_2"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_3"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_4"",""attribute"":""number"",""user_answer"":""number""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""823 + 479 = "",""en"":""823 + 479 = ""},""order"":10},{""type"":""newline"",""order"":15},{""type"":""text"",""content"":{""ja"":""(800 + 400) + (20 + 70) + (3 + 9) = "",""en"":""(800 + 400) + (20 + 70) + (3 + 9) = ""},""order"":20},{""type"":""newline"",""order"":25},{""type"":""input_field"",""field_id"":""f_1"",""order"":30},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":40},{""type"":""input_field"",""field_id"":""f_2"",""order"":45},{""type"":""text"",""content"":{""ja"":"" + "",""en"":"" + ""},""order"":50},{""type"":""input_field"",""field_id"":""f_3"",""order"":60},{""type"":""text"",""content"":{""ja"":"" = "",""en"":"" = ""},""order"":70},{""type"":""input_field"",""field_id"":""f_4"",""order"":80}]}}",1.0.0,300,1,50,,"{""is_correct"":""boolean"",""score"":""number"",""question_text"":{""ja"":""▢にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""3桁同士の足し算で、繰り上がりが2回ある問題に取り組みましょう。"",""en"":""Let's practice adding two three-digit numbers with two carries.""},""question"":{""ja"":""823 + 479 = (800 + 400) + (20 + 70) + (3 + 9) = ▢ + ▢ + ▢ = ▢"",""en"":""823 + 479 = (800 + 400) + (20 + 70) + (3 + 9) = ▢ + ▢ + ▢ = ▢""},""fields"":[{""field_id"":""f_1"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":1200,""en"":1200},""field_explanation"":{""ja"":""800に400を足すと1200になります。"",""en"":""Adding 800 and 400 results in 1200.""}},{""field_id"":""f_2"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":90,""en"":90},""field_explanation"":{""ja"":""20に70を足すと90になります。"",""en"":""Adding 20 and 70 results in 90.""}},{""field_id"":""f_3"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":12,""en"":12},""field_explanation"":{""ja"":""3に9を足すと12になります。"",""en"":""Adding 3 and 9 gives 12.""}},{""field_id"":""f_4"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":1302,""en"":1302},""field_explanation"":{""ja"":""1200と90と12を足すと1302になります。"",""en"":""Summing 1200, 90, and 12 gives 1302.""}}]}",51,"[{""learning_subject"":""算数"",""learning_no"":37,""learning_requirement"":""計算の意味・方法 大きな数の概念と活用 3位数や4位数の加法及び減法"",""learning_required_competency"":""・3～4桁どうしの足し算・引き算を繰り上がり・繰り下がり含め正確に計算できる。"",""learning_background"":""・筆算の手順をしっかり確立させる。"",""learning_category"":""A"",""learning_grade_level"":""小3"",""learning_url"":""""}]",算数,37,計算の意味・方法 大きな数の概念と活用 3位数や4位数の加法及び減法,・3～4桁どうしの足し算・引き算を繰り上がり・繰り下がり含め正確に計算できる。,・筆算の手順をしっかり確立させる。,A,小3,,1699,1,2025-03-18 12:01:37,2025-03-18 12:01:37,
0e572334-4121-4fbb-a56e-015d8de8a43e,1e9506e6-fefd-4241-9193-e94681eb3d46,601a2782-79e1-437c-bc8e-0ac1db49ac43,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g2_sec800_u100_diff100_qt51_v100_203,"{""question_type"":""FILL_IN_THE_BLANK"",""question"":{""ja"":""45 + 36 = 36 + ▢ = ▢"",""en"":""45 + 36 = 36 + ▢ = ▢""},""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""2けたの足し算で順番を変えても結果が同じになる点を確認してみましょう。45 + 36 も 36 + 45 も答えは変わらず、加法の交換法則が成り立ちます。"",""en"":""Let's verify how reversing the order of two-digit addition doesn't change the result. Both 45 + 36 and 36 + 45 produce the same sum, confirming the commutative property.""},""background"":{""ja"":""この問題では、足し算の順番を変えても合計が同じになることを実際の数値で体感し、加法の交換法則を理解させる狙いがあります。繰り上がりのある場合でも同じ答えになることを確認しましょう。"",""en"":""This problem allows learners to experience that switching the order of addition yields the same sum, illustrating the commutative property. Even when carrying is involved, the sum remains unchanged.""},""input_format"":{""type"":""fixed"",""fields"":[{""field_id"":""f_1"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_2"",""attribute"":""number"",""user_answer"":""number""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""45 + 36 = 36 + "",""en"":""45 + 36 = 36 + ""},""order"":1},{""type"":""input_field"",""field_id"":""f_1"",""order"":2},{""type"":""text"",""content"":{""ja"":"" = "",""en"":"" = ""},""order"":3},{""type"":""input_field"",""field_id"":""f_2"",""order"":4}]}}",1.0.0,300,1,50,,"{""is_correct"":""boolean"",""score"":""number"",""question"":{""ja"":""45 + 36 = 36 + ▢ = ▢"",""en"":""45 + 36 = 36 + ▢ = ▢""},""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""45 と 36 の和は 81 です。足し算の順番を変えて 36 + 45 にしても、同じ 81 になることを確かめる問題です。これにより、加法の交換法則が成り立つことを確認します。"",""en"":""The sum of 45 and 36 is 81. Reversing the order to 36 + 45 yields the same result, confirming the commutative property of addition.""},""fields"":[{""field_id"":""f_1"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":45,""en"":45},""field_explanation"":{""ja"":""36 + 45 の形にするには、もとの 45 を入れて正しい式にしてください。"",""en"":""To form 36 + 45, insert the original 45.""}},{""field_id"":""f_2"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":81,""en"":81},""field_explanation"":{""ja"":""45 + 36 も 36 + 45 も合計は 81 です。"",""en"":""Both 45 + 36 and 36 + 45 total 81.""}}]}",51,"[{""learning_subject"":""算数"",""learning_no"":22,""learning_requirement"":""計算の意味・方法 計算の決まり 加法の交換法則を式で示す"",""learning_required_competency"":""a + b = b + a を具体例（3+5=5+3等）で理解し，同じ結果になることを確認できる"",""learning_background"":""実際に小物を数える・ブロックを移し替えるなど操作的活動と組み合わせると，法則への納得感が高まる。後の乗法の交換法則にも発展しやすい"",""learning_category"":""A"",""learning_grade_level"":""小2"",""learning_url"":""""}]",算数,22,計算の意味・方法 計算の決まり 加法の交換法則を式で示す,a + b = b + a を具体例（3+5=5+3等）で理解し，同じ結果になることを確認できる,実際に小物を数える・ブロックを移し替えるなど操作的活動と組み合わせると，法則への納得感が高まる。後の乗法の交換法則にも発展しやすい,A,小2,,213,1,2025-03-18 05:03:14,2025-03-18 08:42:34,
c088c85e-ef8c-430c-8ac0-02e1865b38f9,1e9506e6-fefd-4241-9193-e94681eb3d46,601a2782-79e1-437c-bc8e-0ac1db49ac43,ec663c08-593f-4384-ae6f-a48ee4013e21,ques_s1_g2_sec100_u300_diff100_qt51_v100_200,"{""question_type"":""FILL_IN_THE_BLANK"",""question"":{""ja"":""(4 + 2) + 3 = 4 + (2 + ▢) = ▢"",""en"":""(4 + 2) + 3 = 4 + (2 + ▢) = ▢""},""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""たし算には、(a + b) + c と a + (b + c) のようにまとまりを変えても結果が同じになる『けつごうほうそく』という大事な性質があります。たとえば (4 + 2) + 3 と 4 + (2 + 3) は、どちらも同じ答えになることを確かめましょう。"",""en"":""Addition has an important property called the associative property, which means (a + b) + c and a + (b + c) produce the same result. For example, (4 + 2) + 3 and 4 + (2 + 3) both yield the same answer.""},""background"":{""ja"":""この問題は、加法の結合法則(a + b) + c = a + (b + c) を実際に体験し、たし算でのまとまり方を変えても答えが同じになることを理解してもらうために作られています。"",""en"":""This problem is designed to let learners experience the associative property of addition—(a + b) + c = a + (b + c)—and understand that changing how numbers are grouped does not change the result.""},""input_format"":{""fields"":[{""field_id"":""f_1"",""attribute"":""number"",""user_answer"":""number""},{""field_id"":""f_2"",""attribute"":""number"",""user_answer"":""number""}],""question_components"":[{""type"":""text"",""content"":{""ja"":""(4 + 2) + 3 = "",""en"":""(4 + 2) + 3 = ""},""order"":1},{""type"":""newline"",""order"":5},{""type"":""text"",""content"":{""ja"":""4 + (2 + "",""en"":""4 + (2 + ""},""order"":10},{""type"":""input_field"",""field_id"":""f_1"",""order"":20},{""type"":""text"",""content"":{""ja"":"") = "",""en"":"") = ""},""order"":30},{""type"":""input_field"",""field_id"":""f_2"",""order"":40}]}}",1.0.0,1,1,50,,"{""is_correct"":""boolean"",""score"":""number"",""question"":{""ja"":""(4 + 2) + 3 = 4 + (2 + ▢) = ▢"",""en"":""(4 + 2) + 3 = 4 + (2 + ▢) = ▢""},""question_text"":{""ja"":""つぎの ▢ にあてはまる数を答えなさい。"",""en"":""Please answer the numbers that fit in the blanks.""},""explanation"":{""ja"":""この式は加法の結合法則を示しています。(4 + 2) + 3 も 4 + (2 + 3) も計算結果が同じ9になります。まとめ方を変えても結果は変わらないので、空欄には『3』が入り、最終的に『9』になることを確認しましょう。"",""en"":""This equation illustrates the associative property of addition. Both (4 + 2) + 3 and 4 + (2 + 3) equal 9. The arrangement of the sums does not affect the final result, so the blank is '3' and the total becomes '9'.""},""fields"":[{""field_id"":""f_1"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":3,""en"":3},""field_explanation"":{""ja"":""text"",""en"":""text""}},{""field_id"":""f_2"",""user_answer"":""number"",""is_correct"":""boolean"",""collect_answer"":{""ja"":9,""en"":9},""field_explanation"":{""ja"":""text"",""en"":""text""}}]}",51,"[{""learning_subject"":""算数"",""learning_no"":13,""learning_requirement"":""A 数と計算 計算の意味・方法 加法や減法に関して成り立つ性質"",""learning_required_competency"":""加法および減法について、交換法則(a + b = b + a)や結合法則((a + b) + c = a + (b + c))が成り立つことを具体的に理解できる"",""learning_background"":""具体例や操作活動で、順序・まとまりを変えても結果が変わらないことを確認し、高学年の式操作へつなぐ素地を作る"",""learning_category"":""A"",""learning_grade_level"":""小2"",""learning_url"":""https:\/\/docs.google.com\/spreadsheets\/d\/1W5vaFHcyU_BrMwb1JLZ-DpyFmXXZPaYMTHIITcwLqqY\/edit?gid=0#gid=0&range=13:13""}]",算数,13,A 数と計算 計算の意味・方法 加法や減法に関して成り立つ性質,加法および減法について、交換法則(a + b = b + a)や結合法則((a + b) + c = a + (b + c))が成り立つことを具体的に理解できる,具体例や操作活動で、順序・まとまりを変えても結果が変わらないことを確認し、高学年の式操作へつなぐ素地を作る,A,小2,https://docs.google.com/spreadsheets/d/1W5vaFHcyU_BrMwb1JLZ-DpyFmXXZPaYMTHIITcwLqqY/edit?gid=0#gid=0&range=13:13,200,0,2025-03-17 10:17:54,2025-03-26 02:46:36,

↓{question_translations のパス｝にあるCSVデータの中身
id,question_id,locale,question_text,explanation,background,created_at,updated_at,deleted_at
1,8904117b-6509-42b4-8b18-ec930e037fbd,ja,つぎの ▢ にあてはまる数を答えなさい。,2桁のたし算では、一の位を足して10をこえるときにくり上がりがあります。たとえば 46 + 27 は、一の位が 6 + 7 = 13 となり、そこから 40 + 20 = 60 と合わせることで 73 に計算できます。筆算では、それぞれの位をきちんとそろえて足し算し、くり上がりに注意しましょう。,この問題では、2桁のたし算でくり上がりがある場合の計算方法を理解し、筆算の基礎となる位の考え方を身につけてほしいという狙いがあります。,2025-03-17 10:17:50,2025-03-17 10:17:50,
2,8904117b-6509-42b4-8b18-ec930e037fbd,en,Please answer the numbers that fit in the blanks.,"When adding two-digit numbers, if the ones digit sum is 10 or more, you need to carry over. For example, 46 + 27 has 6 + 7 = 13 in the ones place, then add 40 + 20 = 60 for a total of 73. In column addition, line up each digit carefully and handle the carry properly.","The purpose of this question is to help learners understand how to handle carrying in two-digit addition, reinforcing the concept of place value as the foundation of columnar addition.",2025-03-17 10:17:50,2025-03-17 10:17:50,
3,2202fe7a-0ed1-40c9-bc3b-c398334aecb9,ja,つぎの ▢ にあてはまる数を答えなさい。,2桁のたし算で、一の位の合計が10を超えるときは「くり上がり」に気をつけることが大事です。例えば45 + 36では、5 + 6 = 11 となり、くり上がりが1になります。これを踏まえて、それぞれの位を正しく足し算しましょう。,この問題では、2桁の加法の基礎を身につけてもらうために、数を分解して計算するやり方を理解してもらうことを目的としています。くり上がりの仕組みをしっかり把握し、筆算に抵抗なく取り組めるようにするのが狙いです。,2025-03-17 10:17:51,2025-03-17 10:17:51,

↓{levels のパス｝にあるCSVデータの中身
id,subject_id,json_id,description,memo,version,order,created_at,updated_at,deleted_at
857730f9-6862-4713-b139-d2d77fd0e64d,aeef5c8c-bc52-47bb-9a1b-ff484ee45084,lev_003,,,0.0.1,3,2025-03-17 10:17:10,2025-03-17 10:17:10,
3a0d1bca-4dde-4417-b03b-e1e40557d2bd,aeef5c8c-bc52-47bb-9a1b-ff484ee45084,lev_001,,,0.0.1,1,2025-03-17 10:17:10,2025-03-17 10:17:10,
1e9506e6-fefd-4241-9193-e94681eb3d46,aeef5c8c-bc52-47bb-9a1b-ff484ee45084,lev_002,,,0.0.1,2,2025-03-17 10:17:10,2025-03-17 10:17:10,

↓{grades のパス｝にあるCSVデータの中身
id,json_id,description,memo,version,order,created_at,updated_at,deleted_at
601a2782-79e1-437c-bc8e-0ac1db49ac43,gra_002,,,1.0.0,200,2025-03-17 10:17:11,2025-03-17 10:17:11,
84d4e0a8-7319-42cc-a69a-0c9c9f3cf5ce,gra_007,,,1.0.0,700,2025-03-17 10:17:11,2025-03-17 10:17:11,
323fbc3f-df66-4e1f-9149-0efe9a33cc3e,gra_004,,,1.0.0,400,2025-03-17 10:17:11,2025-03-17 10:17:11,
656f12ff-d648-44f9-b20d-1804ded3ff9d,gra_012,,,1.0.0,1200,2025-03-17 10:17:11,2025-03-17 10:17:11,
f9fdd15d-79fb-4a99-9fac-473daf3aa26e,gra_001,,,1.0.0,100,2025-03-17 10:17:11,2025-03-17 10:17:11,
59b4418e-8afd-496b-8cf1-5f6257000d0c,gra_010,,,1.0.0,1000,2025-03-17 10:17:11,2025-03-17 10:17:11,
cceb0628-7f03-476c-940c-71bb1f2aaf3f,gra_006,,,1.0.0,600,2025-03-17 10:17:11,2025-03-17 10:17:11,
144e93ba-2af4-4fa8-8148-85467b5e1521,gra_003,,,1.0.0,300,2025-03-17 10:17:11,2025-03-17 10:17:11,
a926b5be-ac6b-4fa3-be7c-a7bd7184ce33,gra_011,,,1.0.0,1100,2025-03-17 10:17:11,2025-03-17 10:17:11,
5f710f26-97f3-479e-b105-b8c5bb10b2fa,gra_009,,,1.0.0,900,2025-03-17 10:17:11,2025-03-17 10:17:11,
ebd136ef-1735-477b-80a1-ecc4961edc1d,gra_005,,,1.0.0,500,2025-03-17 10:17:11,2025-03-17 10:17:11,
3076e214-1daf-405e-a1f7-fb8214f02674,gra_008,,,1.0.0,800,2025-03-17 10:17:11,2025-03-17 10:17:11,

↓{difficulties のパス｝にあるCSVデータの中身
id,json_id,version,display_name,order,created_at,updated_at,deleted_at
5a4d9cbf-8e69-4d70-bcad-514cfc7f144d,diff_300,0.0.1,高,3,2025-03-17 10:17:12,2025-03-17 10:17:12,
ec663c08-593f-4384-ae6f-a48ee4013e21,diff_100,0.0.1,低,1,2025-03-17 10:17:12,2025-03-17 10:17:12,
e39cd064-5b19-41fb-84a9-f4f8ac1a0642,diff_200,0.0.1,中,2,2025-03-17 10:17:12,2025-03-17 10:17:12,

# 実装方針
生成また修正変更するコードはそのコードだけは必ず省略せずに必ず全てアウトプットすること。

修正する場合は修正したコードは全て出力し、修正箇所以外のコードやコメントは現状のままにしてください。

仕様はソースコードにまとめてコメントとして残すこと
コメントを残す時に以下のようにコメントへ処理順を示すようなナンバリングは不用です。
// 7) memo => 空白
// 8) generate_question_prompt => そのまま
// 9) generate_question_prompt_file_name => そのまま

ちゃんと解説してね

変更のブランチ名とコミットメッセージを一行で


ーー DB
```php
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('questions', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->unsignedBigInteger('level_id');
            $table->unsignedBigInteger('grade_id');
            $table->unsignedBigInteger('difficulty_id');
            $table->string('json_id')->nullable()->unique();
            $table->json('metadata')->nullable();
            $table->string('version')->default('0.0.1');
            $table->integer('status')->default(1);
            $table->integer('evaluation_method')->default(1);
            $table->integer('checker_method')->nullable();
            $table->integer('llm_evaluation_prompt_file_name')->nullable();
            $table->json('evaluation_response_format')->nullable();
            $table->integer('question_type')->default(1);
            $table->json('learning_requirement_json')->nullable();
            $table->string('learning_subject')->nullable()
                ->comment('科目 (学習要件)');
            $table->integer('learning_no')->nullable()
                ->comment('学習要件の番号');
            $table->text('learning_requirement')->nullable()
                ->comment('学習要件の内容');
            $table->text('learning_required_competency')->nullable()
                ->comment('必要水準');
            $table->text('learning_background')->nullable()
                ->comment('背景・補足');
            $table->string('learning_category')->nullable()
                ->comment('分類');
            $table->string('learning_grade_level')->nullable()
                ->comment('学年');
            $table->string('learning_url')->nullable()
                ->comment('URLリンク');
            $table->integer('order');
            $table->boolean('generated_by_llm')->default(false);
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('level_id')->references('id')->on('levels')->onDelete('cascade');
            $table->foreign('grade_id')->references('id')->on('grades')->onDelete('cascade');
            $table->foreign('difficulty_id')->references('id')->on('difficulties')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        DB::statement('SET FOREIGN_KEY_CHECKS=0;');
        Schema::dropIfExists('questions');
        DB::statement('SET FOREIGN_KEY_CHECKS=1;');
    }
};


<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_sets', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->unsignedBigInteger('unit_id')->nullable();
            $table->string('json_id')->nullable()->unique();
            $table->string('version')->default('0.0.1');
            $table->integer('status')->default(1);
            $table->integer('order');
            $table->longText('generate_question_prompt')->nullable();
            $table->string('generate_question_prompt_file_name')->nullable();
            $table->integer('llm_generation_status')->nullable()->comment('LLMの問題生成を許可するかどうか。LLMでの問題生成が可能な問題かどうかなどを管理');
            $table->integer('consecutive_generation_failures')->default(0)->comment('LLMの問題生成の連続失敗回数');
            $table->boolean('generation_blocked')->default(false)->comment('LLMの問題生成の停止フラグ。失敗が続いた場合に停止');
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('unit_id')->references('id')->on('units')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        DB::statement('SET FOREIGN_KEY_CHECKS=0;');
        Schema::dropIfExists('question_sets');
        DB::statement('SET FOREIGN_KEY_CHECKS=1;');
    }
};


<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_set_translations', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('question_set_id');
            $table->string('locale', 10);
            $table->string('title')->nullable();
            $table->longText('description')->nullable();
            $table->longText('background')->nullable();
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('question_set_id')->references('id')->on('question_sets')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_set_translations');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_translations', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('question_id');
            $table->string('locale', 10);
            $table->longText('question_text')->nullable();
            $table->longText('explanation')->nullable();
            $table->longText('background')->nullable();
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('question_id')->references('id')->on('questions')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_translations');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_set_questions', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->unsignedBigInteger('question_set_id');
            $table->unsignedBigInteger('question_id');
            $table->integer('order');
            $table->timestamps();

            $table->foreign('question_set_id')->references('id')->on('question_sets')->onDelete('cascade');
            $table->foreign('question_id')->references('id')->on('questions')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_set_questions');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_skill', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique();
            $table->unsignedBigInteger('question_id');
            $table->unsignedBigInteger('skill_id');
            $table->integer('order');
            $table->timestamps();
            $table->softDeletes();

            $table->foreign('question_id')->references('id')->on('questions')->onDelete('cascade');
            $table->foreign('skill_id')->references('id')->on('skills')->onDelete('cascade');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_skill');
    }
};
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    /**
     * Run the migrations.
     */
    public function up(): void
    {
        Schema::create('question_generation_logs', function (Blueprint $table) {
            $table->id();
            $table->unsignedBigInteger('question_set_id');
            $table->unsignedBigInteger('question_id')->nullable()->comment('成功時のみ、生成された question を紐づけ');
            $table->timestamp('attempted_at')->nullable()->comment('LLM生成を試みた日時');
            $table->longText('prompt')->nullable()->comment('LLMに投げたプロンプト');

            /**
             * question_set_content: 生成時点のQuestionSetのスナップショットをJSON形式で保存
             * 例)
             * {
             *   "version": "1.2.3",
             *   "title": {
             *     "ja": "日本語タイトル",
             *     "en": "English Title"
             *     // 他の言語分も必要に応じて
             *   },
             *   "description": {
             *     "ja": "日本語の説明文",
             *     "en": "English description"
             *   },
             *   "background": {
             *     "ja": "背景情報(日本語)",
             *     "en": "Background info in English"
             *   }
             * }
             */
            $table->json('question_set_content')->comment('生成時点のQuestionSet情報 (version,多言語のtitle/description/background等)をJSONで');

            $table->boolean('is_success')->default(false)->comment('生成に成功したかどうか');

            $table->longText('error_message')->nullable()->comment('失敗時のエラー内容や例外メッセージ等');
            $table->longText('llm_response')->nullable()->comment('LLM応答全文 (JSON等)');

            $table->boolean('google_drive_uploaded')
                ->default(false)
                ->comment('Google Driveへアップロード済みかどうか');

            $table->timestamps();
            $table->softDeletes();

            // 外部キー設定
            $table->foreign('question_set_id')
                ->references('id')
                ->on('question_sets')
                ->onDelete('cascade');

            $table->foreign('question_id')
                ->references('id')
                ->on('questions')
                ->onDelete('set null');
        });
    }

    /**
     * Reverse the migrations.
     */
    public function down(): void
    {
        Schema::dropIfExists('question_generation_logs');
    }
};

<?php

namespace App\Models\Question;

use App\Models\BaseModel;
use App\Models\Difficulty\Difficulty;
use App\Models\Grade\Grade;
use App\Models\Level\Level;
use App\Models\Skill\Skill;
use App\Traits\HasOrder;
use App\Traits\UsesUuid;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 *
 *
 * @property string $id
 * @property string $level_id
 * @property string $difficulty_id
 * @property string|null $json_id
 * @property string|null $metadata
 * @property string $version
 * @property int $status
 * @property int $question_type
 * @property string|null $learning_subject 科目 (学習要件) e.g. "Arithmetic"
 * @property int|null $learning_no 学習要件の番号 e.g. 10
 * @property string|null $learning_requirement 学習要件の内容 "Numbers and Calculation..."
 * @property string|null $learning_required_competency 必要水準 "Understand multiplication..."
 * @property string|null $learning_category 分類 e.g. "A", "B"
 * @property string|null $learning_grade_level 学年 e.g. "Grade 2"
 * @property string|null $learning_url URLリンク e.g. "https://docs.google.com/..."
 * @property int $order
 * @property int $generated_by_llm
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question onlyTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question query()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereDeletedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereDifficultyId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereGeneratedByLlm($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereJsonId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningCategory($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningGradeLevel($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningNo($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningRequiredCompetency($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningRequirement($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningSubject($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningUrl($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLevelId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereMetadata($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereOrder($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereQuestionType($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereStatus($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereVersion($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question withTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question withoutTrashed()
 * @property int $evaluation_method
 * @property int|null $checker_method
 * @property-read \Illuminate\Database\Eloquent\Collection<int, \App\Models\Question\QuestionTranslation> $translations
 * @property-read int|null $translations_count
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereCheckerMethod($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereEvaluationMethod($value)
 * @property string|null $llm_evaluation_prompt
 * @property string|null $evaluation_response_format
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLlmEvaluationPrompt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLlmEvaluationResponseFormat($value)
 * @property int|null $llm_evaluation_prompt_file_name
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLlmEvaluationPromptNumber($value)
 * @property string|null $learning_requirement_json
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningRequirementJson($value)
 * @property string|null $learning_background 背景・補足
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLearningBackground($value)
 * @property string $grade_id
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereGradeId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereEvaluationResponseFormat($value)
 * @property-read \Illuminate\Database\Eloquent\Collection<int, Skill> $skills
 * @property-read int|null $skills_count
 * @method static \Illuminate\Database\Eloquent\Builder<static>|Question whereLlmEvaluationPromptFileName($value)
 * @property-read Difficulty $difficulty
 * @property-read Grade $grade
 * @property-read Level $level
 * @mixin \Eloquent
 */
class Question extends BaseModel
{
    use HasOrder, UsesUuid, SoftDeletes;

    public $sortable = [
        'order_column_name' => 'order',
        'sort_when_creating' => true,
    ];
    protected $with = [
        'translations',
    ];

    /*=====================================================
    * リレーション
    *=====================================================*/

    /**
     * 翻訳テーブルとのリレーション
     */
    public function translations()
    {
        return $this->hasMany(QuestionTranslation::class, 'question_id');
    }
    public function skills()
    {
        return $this->belongsToMany(Skill::class, 'question_skill', 'question_id', 'skill_id')
            ->withPivot('order')
            ->withTimestamps();
    }

    public function level()
    {
        return $this->belongsTo(Level::class);
    }

    public function grade()
    {
        return $this->belongsTo(Grade::class);
    }
    public function difficulty()
    {
        return $this->belongsTo(Difficulty::class);
    }
}


<?php

namespace App\Models\Question;

use App\Enums\QuestionSetStatus;
use App\Models\BaseModel;
use App\Models\Unit\Unit;
use App\Models\User\UserQuestionSetTranslation;
use App\Traits\HasOrder;
use App\Traits\UsesUuid;
use Illuminate\Database\Eloquent\Builder;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 *
 *
 * @property string $id
 * @property string|null $unit_id
 * @property string|null $json_id
 * @property string $version
 * @property int $status
 * @property int $order
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @property-read \Illuminate\Database\Eloquent\Collection<int, \App\Models\Question\QuestionSetTranslation> $translations
 * @property-read int|null $translations_count
 * @method static Builder<static>|QuestionSet newModelQuery()
 * @method static Builder<static>|QuestionSet newQuery()
 * @method static Builder<static>|QuestionSet onlyTrashed()
 * @method static Builder<static>|QuestionSet published()
 * @method static Builder<static>|QuestionSet query()
 * @method static Builder<static>|QuestionSet whereCreatedAt($value)
 * @method static Builder<static>|QuestionSet whereDeletedAt($value)
 * @method static Builder<static>|QuestionSet whereId($value)
 * @method static Builder<static>|QuestionSet whereJsonId($value)
 * @method static Builder<static>|QuestionSet whereOrder($value)
 * @method static Builder<static>|QuestionSet whereStatus($value)
 * @method static Builder<static>|QuestionSet whereUnitId($value)
 * @method static Builder<static>|QuestionSet whereUpdatedAt($value)
 * @method static Builder<static>|QuestionSet whereVersion($value)
 * @method static Builder<static>|QuestionSet withTrashed()
 * @method static Builder<static>|QuestionSet withoutTrashed()
 * @property-read \Illuminate\Database\Eloquent\Collection<int, \App\Models\Question\QuestionSetQuestion> $questionSetQuestions
 * @property-read int|null $question_set_questions_count
 * @property-read \Illuminate\Database\Eloquent\Collection<int, \App\Models\Question\Question> $questions
 * @property-read int|null $questions_count
 * @property string|null $generate_question_prompt
 * @property string|null $generate_question_prompt_file_name
 * @property int|null $llm_generation_status LLMの問題生成を許可するかどうか。LLMでの問題生成が可能な問題かどうかなどを管理
 * @property int $consecutive_generation_failures LLMの問題生成の連続失敗回数
 * @property int $generation_blocked LLMの問題生成の停止フラグ。失敗が続いた場合に停止
 * @property-read Unit|null $unit
 * @method static Builder<static>|QuestionSet whereConsecutiveGenerationFailures($value)
 * @method static Builder<static>|QuestionSet whereGenerateQuestionPrompt($value)
 * @method static Builder<static>|QuestionSet whereGenerateQuestionPromptFileName($value)
 * @method static Builder<static>|QuestionSet whereGenerationBlocked($value)
 * @method static Builder<static>|QuestionSet whereLlmGenerationStatus($value)
 * @mixin \Eloquent
 */
class QuestionSet extends BaseModel
{
    use HasOrder, UsesUuid, SoftDeletes;

    public $sortable = [
        'order_column_name' => 'order',
        'sort_when_creating' => true,
    ];
    protected $with = [
        'translations',
    ];

    /*=====================================================
    * Relation
    *=====================================================*/
    /**
     * 翻訳テーブルとのリレーション
     */
    public function translations()
    {
        return $this->hasMany(QuestionSetTranslation::class, 'question_set_id');
    }

    public function questionSetQuestions()
    {
        // PIVOT: question_set_questions
        return $this->hasMany(QuestionSetQuestion::class, 'question_set_id');
    }

    public function questions()
    {
        return $this->belongsToMany(Question::class, 'question_set_questions', 'question_set_id', 'question_id')
            ->withPivot('order')
            ->withTimestamps();
    }

    public function unit()
    {
        return $this->belongsTo(Unit::class);
    }

    /*=====================================================
 * カスタムメソッド/Custom Method
*=====================================================*/

    /**
     * 現在のlocaleに応じた翻訳を返す
     * なければfallback_localeの翻訳を返す
     */
    public function getTranslation(?string $locale = null): ?QuestionSetTranslation
    {
        $locale = $locale ?: app()->getLocale();
        return $this->translations->firstWhere('locale', $locale)
            ?: $this->translations->firstWhere('locale', config('app.fallback_locale'));
    }

    /*=====================================================
    * Scope
    *=====================================================*/

    /**
     * 公開(PUBLISHED)だけを絞り込むスコープ
     */
    public function scopePublished(Builder $query): Builder
    {
        return $query->where('status', QuestionSetStatus::PUBLISHED->value);
    }
}
<?php

namespace App\Models\Question;

use App\Models\BaseModel;
use App\Traits\HasOrder;
use App\Traits\UsesUuid;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 *
 *
 * @property string $id
 * @property string|null $unit_id
 * @property string|null $json_id
 * @property string $version
 * @property int $status
 * @property int $order
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet onlyTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet query()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereDeletedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereJsonId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereOrder($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereStatus($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereUnitId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet whereVersion($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet withTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSet withoutTrashed()
 * @property string $question_set_id
 * @property string $question_id
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetQuestion whereQuestionId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetQuestion whereQuestionSetId($value)
 * @property-read \App\Models\Question\Question|null $question
 * @mixin \Eloquent
 */
class QuestionSetQuestion extends BaseModel
{
    use UsesUuid, HasOrder;

    public $sortable = [
        'order_column_name' => 'order',
        'sort_when_creating' => true,
    ];

    /*=====================================================
    * Relation
    *=====================================================*/
    public function question()
    {
        return $this->belongsTo(Question::class, 'question_id');
    }
}
<?php

namespace App\Models\Question;

use App\Models\BaseModel;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * 
 *
 * @property int $id
 * @property string $question_set_id
 * @property string $locale
 * @property string|null $title
 * @property string|null $description
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation onlyTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation query()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereDeletedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereDescription($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereLocale($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereQuestionSetId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereTitle($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation withTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation withoutTrashed()
 * @property string|null $background
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionSetTranslation whereBackground($value)
 * @mixin \Eloquent
 */
class QuestionSetTranslation extends BaseModel
{
    use SoftDeletes;

    protected $fillable = [
        'question_set_id',
        'locale',
        'title',
        'description',
        'background'
    ];
}
<?php

namespace App\Models\Question;

use App\Models\BaseModel;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;

/**
 * 
 *
 * @property int $id
 * @property string $question_id
 * @property string $locale
 * @property string|null $question_text
 * @property string|null $explanation
 * @property \Illuminate\Support\Carbon|null $created_at
 * @property \Illuminate\Support\Carbon|null $updated_at
 * @property \Illuminate\Support\Carbon|null $deleted_at
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation newModelQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation newQuery()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation onlyTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation query()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereCreatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereDeletedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereExplanation($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereLocale($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereQuestionId($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereQuestionText($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereUpdatedAt($value)
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation withTrashed()
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation withoutTrashed()
 * @property string|null $background
 * @method static \Illuminate\Database\Eloquent\Builder<static>|QuestionTranslation whereBackground($value)
 * @mixin \Eloquent
 */
class QuestionTranslation extends BaseModel
{
    use SoftDeletes;
    protected $fillable = [
        'question_id',
        'locale',
        'question_text',
        'explanation',
        'background'
    ];

}

```

---　参考 QuestionJson の取り込みコマンド

```php
<?php

namespace App\Console\Commands\Import\Github;

use App\Enums\EvaluationCheckerMethod;
use App\Enums\EvaluationMethod;
use App\Enums\QuestionStatus;
use App\Enums\QuestionType;
use App\Models\Difficulty\Difficulty;
use App\Models\Grade\Grade;
use App\Models\Level\Level;
use App\Models\Question\Question;
use App\Models\Question\QuestionTranslation;
use App\Services\Utils\Question\QuestionJsonManageService;
use Google_Client;
use Google_Service_Drive;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Str;

/**
 * 【仕様まとめ】
 * 1) staging や local 環境で Google Drive 上の JSON を取り込みたい場合、
 *    サービスアカウント (service-account-credentials.json) で認証し、Drive API を介してダウンロードする。
 * 2) Google Drive でファイルを「service account」に対して共有(閲覧可)し、かつ GCP で Drive API を有効化しておく必要がある。
 * 3) $jsonFileOnGoogleDriveIds にファイルIDを記述しておくと、全て順番にダウンロードし upsertQuestion() へ渡す。
 * 4) GitHub からの取り込み (importFromGitHub) は既存の通り残し、環境が 'staging' なら Drive API、その他はローカル設定で切り替え。
 * 5) 既存の upsertQuestion(), processJsonFile(), fetchAllJsonFilesRecursively() 等のロジックはそのまま利用。
 */

class ImportQuestionsFromGithub extends Command
{
    /**
     * artisan で呼び出すコマンド名
     *
     * 例: php artisan import:questions-from-github --subject=math
     */
    protected $signature = 'import:questions-from-github
                            {--subject= : If specified, only import files under contents/questions/{subject} }';

    protected $description = 'Import question data from GitHub or Google Drive JSON files and sync DB';

    /**
     * Google Drive 上の "ファイルID" 一覧 (サービスアカウント認証で取得する)
     *
     * 例:
     *   https://drive.google.com/file/d/1jPnYxj8VxeUT5JmnAayPUpl-2BnEJ-ax/view?usp=sharing
     *   ↑のURLの「1jPnYxj8VxeUT5JmnAayPUpl-2BnEJ-ax」がファイルID。
     */
    protected array $jsonFileOnGoogleDriveIds = [
        '1o6db1AIwflqfraGwC6IU2re18Zxtv3Kc',
        '1D0AG1gR9Lt7GO5O8hDqlTgRoVxDGCoMH',
        '1OOxfWOTVixHRqTWpQWXVOM1BcdWMBnxi'
    ];
    /**
     * 「取り込もうとしたJSONの総数」
     */
    private int $totalCount = 0;

    /**
     * 「取り込みに失敗またはスキップしたJSONの総数」
     */
    private int $skipCount = 0;

    /**
     * 「取り込みに成功したJSONの総数」
     */
    private int $successCount = 0;

    /**
     * メインのハンドラ
     */
    public function handle()
    {
        // 環境判定
        $env = app()->environment(); // 'local', 'staging', etc
        $useGoogleDrive = false;

        if ($env === 'staging') {
            // staging は必ず Google Drive
            $useGoogleDrive = true;
        } elseif ($env === 'local') {
            // local では config('app.use_google_drive_in_local_for_learning_data_import', true) の値を参照
            $useGoogleDrive = config('app.use_google_drive_in_local_for_learning_data_import', true);
        }

        if ($useGoogleDrive) {
            $this->info("【INFO】Running in '{$env}' environment => Google Drive (Service Account認証) からJSONをダウンロードして処理します。");
            $this->importFromGoogleDriveWithServiceAccount();
        } else {
            $this->info("【INFO】Running in '{$env}' environment => GitHub からJSONをダウンロードして処理します。");
            $this->importFromGitHub();
        }

        // 統計出力
        $this->info("Import process completed.");
        $this->line("=======================================");
        $this->info("取り込もうとした Question JSON の総数: {$this->totalCount}");
        $this->info("取り込みに失敗またはスキップした Question JSON の総数: {$this->skipCount}");
        $this->info("取り込みに成功した Question JSON の総数: {$this->successCount}");
        $this->line("=======================================");

        return 0;
    }

    /**
     * 【B案】Google Drive のファイルを
     * Service Account (service-account-credentials.json) で認証して Drive API 経由でダウンロードする。
     *
     * jsonFileOnGoogleDriveIds に記載された複数ファイルを順に読み取り、DBに反映する。
     */
    private function importFromGoogleDriveWithServiceAccount(): void
    {
        $this->info('Setting up Google Client for Drive API (Questions) ...');

        // 1) Googleクライアントの認証設定
        //    例: storage_path('app/private/service-account-credentials.json')
        $client = new Google_Client();
        $client->setAuthConfig(storage_path('app/private/service-account-credentials.json'));
        $client->addScope(Google_Service_Drive::DRIVE_READONLY);

        // 2) Drive サービスインスタンス
        $driveService = new Google_Service_Drive($client);

        // 3) ファイルID をループし、中身(JSON)をダウンロード => upsert
        foreach ($this->jsonFileOnGoogleDriveIds as $fileId) {
            $this->info("Fetching JSON from Google Drive fileId: {$fileId}");

            // 総数カウント
            $this->totalCount++;

            try {
                // alt=media で取得 (認証済ストリーム)
                $response = $driveService->files->get($fileId, ['alt' => 'media']);
                $jsonContent = $response->getBody()->getContents();

                $decoded = json_decode($jsonContent, true);
                if (!is_array($decoded)) {
                    $this->warn("File ID={$fileId} is not valid JSON. Skipped.");
                    $this->skipCount++;
                    continue;
                }

                // DB upsert
                if ($this->upsertQuestion($decoded)) {
                    $this->successCount++;
                } else {
                    $this->skipCount++;
                }
            } catch (\Exception $e) {
                $this->warn("Failed to fetch from Google Drive: fileId={$fileId}, error=" . $e->getMessage());
                $this->skipCount++;
            }
        }
    }

    /**
     * GitHubリポジトリ上の JSON を取り込み（オリジナルロジックを温存）
     */
    private function importFromGitHub(): void
    {
        $token = config('services.github.api_token');
        if (!$token) {
            $this->error('GitHub API token not found in config/services.php [github.api_token]');
            return;
        }

        $repoOwnerAndName = 'NousContentsManagement/masamo-content';

        // ベースパス: contents/questions
        $basePath = 'contents/questions';

        // subject オプション
        $subjectOption = $this->option('subject');
        if ($subjectOption) {
            $basePath .= '/' . $subjectOption;
            $this->info("Subject specified: {$subjectOption}, path= {$basePath}");
        } else {
            $this->info("No subject specified. Will import from all subdirectories under contents/questions");
        }

        $allJsonFiles = $this->fetchAllJsonFilesRecursively($repoOwnerAndName, $basePath, $token);
        if (empty($allJsonFiles)) {
            $this->warn("No JSON files found under path: {$basePath}");
            return;
        }

        $this->info("Found " . count($allJsonFiles) . " JSON file(s) under {$basePath}");

        // 各ファイルを処理
        foreach ($allJsonFiles as $file) {
            $this->processJsonFile($file, $token);
        }
    }

    /**
     * 再帰的に GitHub 上のディレクトリを走査し、.json ファイル一覧を返す
     */
    private function fetchAllJsonFilesRecursively(string $repo, string $path, string $token): array
    {
        $url = "https://api.github.com/repos/{$repo}/contents/{$path}";
        $response = Http::withToken($token)->get($url);

        if ($response->failed()) {
            $this->warn("Failed to fetch from GitHub: {$url}, status={$response->status()}");
            return [];
        }

        $items = $response->json();
        if (!is_array($items)) {
            return [];
        }

        $result = [];

        foreach ($items as $item) {
            $type = $item['type'] ?? null;  // 'file' or 'dir'
            $itemPath = $item['path'] ?? '';
            $name     = $item['name'] ?? '';

            if ($type === 'dir') {
                $descendantFiles = $this->fetchAllJsonFilesRecursively($repo, $itemPath, $token);
                $result = array_merge($result, $descendantFiles);
            } elseif ($type === 'file') {
                if (str_ends_with($name, '.json')) {
                    $result[] = $item;
                }
            }
        }

        return $result;
    }

    /**
     * JSONファイル一件をダウンロードしてパースし、DBに反映 (GitHub用)
     */
    private function processJsonFile(array $file, string $token): void
    {
        $this->totalCount++;

        if (!isset($file['download_url'])) {
            $this->warn("No download_url for file: " . ($file['path'] ?? 'unknown'));
            $this->skipCount++;
            return;
        }

        $this->info("Fetching JSON: " . $file['path']);

        $jsonContent = Http::withToken($token)
            ->get($file['download_url'])
            ->body();

        $decoded = json_decode($jsonContent, true);
        if (!is_array($decoded)) {
            $this->warn("File {$file['name']} is not valid JSON. Skipped.");
            $this->skipCount++;
            return;
        }

        if ($this->upsertQuestion($decoded)) {
            $this->successCount++;
        } else {
            $this->skipCount++;
        }
    }

    /**
     * 単一の問題(JSON)をDBへ upsert
     *
     * @return bool 成功ならtrue、スキップ/失敗ならfalse
     */
    private function upsertQuestion(array $questionJson): bool
    {
        DB::beginTransaction();
        try {
            $jsonId = $questionJson['id'] ?? null;
            if (!$jsonId) {
                $this->warn("Question JSON missing 'id'. Skipped.");
                DB::rollBack();
                return false;
            }

            // metadata が無いならスキップ
            $metadata = $questionJson['metadata'] ?? [];
            if (empty($metadata)) {
                $this->warn("metadata が存在しないためスキップ: json_id={$jsonId}");
                DB::rollBack();
                return false;
            }

            // JSONバリデーション
            try {
                $jsonManager = app(QuestionJsonManageService::class);
                $jsonManager->validateQuestionJson($questionJson);
            } catch (\Illuminate\Validation\ValidationException $ve) {
                $this->warn("バリデーションエラーのため問題(json_id={$jsonId})をスキップ:");
                foreach ($ve->errors() as $field => $msgs) {
                    foreach ($msgs as $msg) {
                        $this->warn("  - {$field}: {$msg}");
                    }
                }
                DB::rollBack();
                return false;
            }

            // 既存レコードを検索 (json_id = $jsonId)
            $question = Question::where('json_id', $jsonId)->first();

            // order, version
            $jsonOrder = $questionJson['order'] ?? 9999;
            $version   = $questionJson['version'] ?? '0.0.1';

            // status
            $rawStatus = $questionJson['status'] ?? null;
            $statusValue = $rawStatus
                ? $this->parseQuestionStatus($rawStatus)
                : QuestionStatus::DRAFT->value;

            // level_id / difficulty_id / grade_id
            $levelUuid      = $this->findLevelUuid($questionJson['level_id'] ?? null);
            $gradeUuid      = $this->findGradeUuid($questionJson['grade_id'] ?? null);
            $difficultyUuid = $this->findDifficultyUuid($questionJson['difficulty_id'] ?? null);

            // 新規or既存
            if (!$question) {
                $question = new Question();
                $question->uuid      = (string) Str::uuid();
                $question->json_id = $jsonId;
            }

            // 項目反映
            $question->order = $questionJson['order'];
            $question->level_id      = $levelUuid;
            $question->grade_id      = $gradeUuid;
            $question->difficulty_id = $difficultyUuid;
            $question->version       = $version;
            $question->status        = $statusValue;

            // question->metadata
            $question->metadata = json_encode($metadata, JSON_UNESCAPED_UNICODE);

            // question_type
            $rawQuestionType = $metadata['question_type'] ?? null;
            $question->question_type = $this->parseQuestionType($rawQuestionType);

            // evaluation_spec
            if (isset($questionJson['evaluation_spec'])) {
                $em = $questionJson['evaluation_spec']['evaluation_method'] ?? null;
                $cm = $questionJson['evaluation_spec']['checker_method'] ?? null;
                $question->evaluation_method = $em
                    ? EvaluationMethod::fromString($em)
                    : null;
                $question->checker_method = $cm
                    ? EvaluationCheckerMethod::fromString($cm)
                    : null;

                $question->llm_evaluation_prompt_file_name = $questionJson['evaluation_spec']['llm_prompt_file_name'] ?? null;

                $rf = $questionJson['evaluation_spec']['response_format'] ?? null;
                $question->evaluation_response_format = $rf
                    ? json_encode($rf, JSON_UNESCAPED_UNICODE)
                    : null;
            }

            // generated_by_llm
            if (array_key_exists('generated_by_llm', $questionJson)) {
                $question->generated_by_llm = (bool)$questionJson['generated_by_llm'];
            }

            // 学習要件
            $this->applyLearningRequirements($question, $questionJson);

            $question->save();

            // question_text / explanation / background
            $this->upsertQuestionTranslations($question, $questionJson);

            // skills → pivot
            $this->applySkillsPivot($question, $questionJson);

            DB::commit();
            $this->info("Upserted question json_id={$jsonId}");
            return true;

        } catch (\Throwable $e) {
            DB::rollBack();
            $this->error("Error upserting question json_id={$jsonId}: " . $e->getMessage());
            return false;
        }
    }

    /**
     * JSON の "skills" 配列 → question_skill ピボットを同期
     */
    private function applySkillsPivot(Question $question, array $questionJson)
    {
        $skillsFromJson = $questionJson['skills'] ?? [];

        $newSkillDbIds = [];
        $skillIndexMap = [];

        foreach ($skillsFromJson as $index => $skillData) {
            $skillJsonId = $skillData['skill_id'] ?? null;
            if (!$skillJsonId) {
                continue;
            }

            // skills テーブルの json_id => id
            $skillDbId = DB::table('skills')
                ->where('json_id', $skillJsonId)
                ->value('id');

            if (!$skillDbId) {
                $this->warn("Skill with json_id='{$skillJsonId}' not found. Skipped linking.");
                continue;
            }

            $newSkillDbIds[] = $skillDbId;
            $skillIndexMap[$skillDbId] = $index + 1;
        }

        // 既存 pivot
        $existingSkillDbIds = DB::table('question_skill')
            ->where('question_id', $question->id)
            ->pluck('skill_id')
            ->toArray();

        // 削除すべきスキル
        $skillIdsToRemove = array_diff($existingSkillDbIds, $newSkillDbIds);
        if (!empty($skillIdsToRemove)) {
            DB::table('question_skill')
                ->where('question_id', $question->id)
                ->whereIn('skill_id', $skillIdsToRemove)
                ->delete();
        }

        // 追加または更新
        foreach ($newSkillDbIds as $skillDbId) {
            $existingPivot = DB::table('question_skill')
                ->where('question_id', $question->id)
                ->where('skill_id', $skillDbId)
                ->first();

            if ($existingPivot) {
                DB::table('question_skill')
                    ->where('id', $existingPivot->id)
                    ->update([
                        'order'      => $skillIndexMap[$skillDbId],
                        'updated_at' => now(),
                    ]);
            } else {
                DB::table('question_skill')->insert([
                    'uuid'          => (string) Str::uuid(),
                    'question_id' => $question->id,
                    'skill_id'    => $skillDbId,
                    'order'       => $skillIndexMap[$skillDbId],
                    'created_at'  => now(),
                    'updated_at'  => now(),
                ]);
            }
        }
    }

    /**
     * question_text, explanation, background を question_translations へ upsert
     */
    private function upsertQuestionTranslations(Question $question, array $questionJson)
    {
        $locales = ['ja','en'];

        foreach ($locales as $locale) {
            $qText = $questionJson['metadata']['question_text'][$locale] ?? null;
            $qExp  = $questionJson['metadata']['explanation'][$locale]   ?? null;
            $qBack = $questionJson['metadata']['background'][$locale]    ?? null;

            if ($qText !== null || $qExp !== null || $qBack !== null) {
                QuestionTranslation::updateOrCreate(
                    [
                        'question_id' => $question->id,
                        'locale'      => $locale,
                    ],
                    [
                        'question_text' => $qText,
                        'explanation'   => $qExp,
                        'background'    => $qBack,
                    ]
                );
            }
        }
    }

    /**
     * JSON の learning_requirements を反映
     */
    private function applyLearningRequirements(Question $question, array $questionJson)
    {
        $items = $questionJson['learning_requirements'] ?? [];
        if (!is_array($items) || empty($items)) {
            return;
        }
        $question->learning_requirement_json = json_encode($items, JSON_UNESCAPED_UNICODE);

        $subjects             = [];
        $nos                  = [];
        $requirements         = [];
        $requiredCompetencies = [];
        $backgrounds          = [];
        $categories           = [];
        $gradeLevels          = [];
        $urls                 = [];

        foreach ($items as $lr) {
            if (isset($lr['learning_subject'])) {
                $subjects[] = $lr['learning_subject'];
            }
            if (isset($lr['learning_no'])) {
                $nos[] = (string)$lr['learning_no'];
            }
            if (isset($lr['learning_requirement'])) {
                $requirements[] = $lr['learning_requirement'];
            }
            if (isset($lr['learning_required_competency'])) {
                $requiredCompetencies[] = $lr['learning_required_competency'];
            }
            if (isset($lr['learning_background'])) {
                $backgrounds[] = $lr['learning_background'];
            }
            if (isset($lr['learning_category'])) {
                $categories[] = $lr['learning_category'];
            }
            if (isset($lr['learning_grade_level'])) {
                $gradeLevels[] = $lr['learning_grade_level'];
            }
            if (isset($lr['learning_url'])) {
                $urls[] = $lr['learning_url'];
            }
        }

        $question->learning_subject             = implode("\n", $subjects);
        $question->learning_no                  = !empty($nos) ? (int)$nos[0] : null;
        $question->learning_requirement         = implode("\n", $requirements);
        $question->learning_required_competency = implode("\n", $requiredCompetencies);
        $question->learning_background          = implode("\n", $backgrounds);
        $question->learning_category            = implode("\n", $categories);
        $question->learning_grade_level         = implode("\n", $gradeLevels);
        $question->learning_url                 = implode("\n", $urls);
    }

    /**
     * JSON の level_id => levelsテーブル json_idカラム => uuid
     */
    private function findLevelUuid(?string $levelJsonId): ?string
    {
        if (!$levelJsonId) {
            return null;
        }
        return Level::where('json_id', $levelJsonId)->value('id') ?: null;
    }

    /**
     * JSON の grade_id => gradesテーブル json_idカラム => uuid
     */
    private function findGradeUuid(?string $gradeJsonId): ?string
    {
        if (!$gradeJsonId) {
            return null;
        }
        return Grade::where('json_id', $gradeJsonId)->value('id') ?: null;
    }

    /**
     * JSON の difficulty_id => difficultiesテーブル json_idカラム => uuid
     */
    private function findDifficultyUuid(?string $difficultyJsonId): ?string
    {
        if (!$difficultyJsonId) {
            return null;
        }
        return Difficulty::where('json_id', $difficultyJsonId)->value('id') ?: null;
    }

    /**
     * question_type 文字列 -> Enum (int値) に変換
     */
    private function parseQuestionType(?string $typeString): int
    {
        if (!$typeString) {
            // デフォルト
            return QuestionType::CALCULATION->value;
        }

        try {
            return QuestionType::fromString($typeString)->value;
        } catch (\InvalidArgumentException) {
            return QuestionType::CALCULATION->value;
        }
    }

    /**
     * status 文字列 -> QuestionStatus enum (int) に変換
     */
    private function parseQuestionStatus(string $statusString): int
    {
        try {
            return QuestionStatus::fromString($statusString)->value;
        } catch (\InvalidArgumentException) {
            return QuestionStatus::DRAFT->value;
        }
    }
}
```

